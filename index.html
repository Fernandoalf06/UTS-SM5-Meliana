<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal UTS - 1123210254</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Konfigurasi PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4338ca"> <!-- Indigo-700 -->
    
    <!-- Ikon Apple Touch -->
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4338ca/ffffff?text=UTS">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Menggunakan font Inter sebagai default */
        body {
            font-family: 'Inter', sans-serif;
            /* Latar belakang gradien halus */
            background-color: #f8fafc; /* slate-50 */
        }
        /* Animasi fade-in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Style untuk hitung mundur */
        .countdown-box {
            /* Gradien baru yang lebih modern */
            background: linear-gradient(135deg, #4f46e5, #3730a3); /* Indigo-600 ke Indigo-800 */
            animation: fadeIn 0.5s ease-out;
        }
        /* Style untuk bilah warna harian */
        .day-bar {
            width: 6px;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            border-top-left-radius: 0.75rem; /* rounded-xl */
            border-bottom-left-radius: 0.75rem; /* rounded-xl */
        }
        /* Palet warna untuk hari */
        .day-senin { background-color: #ef4444; } /* red-500 */
        .day-selasa { background-color: #3b82f6; } /* blue-500 */
        .day-rabu { background-color: #10b981; } /* emerald-500 */
        .day-kamis { background-color: #eab308; } /* yellow-500 */
        .day-jumat { background-color: #8b5cf6; } /* violet-500 */
        
        /* Transisi untuk hover dan klik */
        .btn-animated {
            transition: all 0.2s ease-in-out;
        }
        .btn-animated:hover {
            transform: translateY(-2px);
            filter: brightness(1.05);
        }
        .btn-animated:active {
            transform: translateY(-1px) scale(0.98);
        }
        
        .card-animated {
            transition: all 0.2s ease-in-out;
        }
        .card-animated:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
        }
    </style>
</head>
<body class="bg-slate-50 p-4 sm:p-8">

    <div class="w-full max-w-4xl mx-auto">
        <!-- Header -->
        <header class="mb-6 fade-in">
            <h1 class="text-3xl font-bold text-gray-900">Jadwal UTS (Gasal 2025/2026)</h1>
            <p class="text-lg text-gray-600">Meliana Gita Puspitasari (1123210254)</p>
        </header>

        <!-- Boks Hitung Mundur -->
        <div id="countdownBox" class="countdown-box text-white p-5 rounded-xl shadow-lg mb-6 hidden">
            <h2 class="text-lg font-semibold opacity-90">Ujian Berikutnya:</h2>
            <p id="nextExamSubject" class="text-2xl font-bold"></p>
            <p id="countdownTimer" class="text-xl mt-1"></p>
        </div>

        <!-- Kontrol Urutkan dan Ekspor -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4 fade-in" style="animation-delay: 0.1s;">
            <!-- Dropdown Urutkan -->
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <label for="sortOrder" class="text-sm font-medium text-gray-700">Urutkan:</label>
                <select id="sortOrder" class="w-full sm:w-auto rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition duration-150">
                    <option value="date" selected>Tanggal Ujian (Terdekat)</option>
                    <option value="alphabetical">Nama Mata Kuliah (A-Z)</option>
                </select>
            </div>
            <!-- Tombol Ekspor -->
            <button id="exportAllButton" class="w-full sm:w-auto bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-5 rounded-lg shadow-md btn-animated flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" />
                </svg>
                Ekspor Semua (.ics)
            </button>
        </div>

        <!-- Daftar Jadwal -->
        <div id="scheduleList" class="space-y-5">
            <!-- Kartu jadwal akan dimasukkan oleh JavaScript di sini -->
        </div>
    </div>

    <script>
        // --- DATA JADWAL (DIPERBARUI SESUAI GAMBAR) ---
        const scheduleData = [
            { id: "MKT301", date: "2025-10-30", time: "08:30", subject: "Seminar Pemasaran Kreatif", room: "406", seat: "19", day: "Kamis" },
            { id: "RES302", date: "2025-11-04", time: "08:30", subject: "Metodologi Penelitian", room: "401", seat: "16", day: "Selasa" },
            { id: "MAN401", date: "2025-10-27", time: "14:00", subject: "Manajemen Strategi", room: "401", seat: "25", day: "Senin" },
            { id: "BRD402", date: "2025-10-31", time: "08:30", subject: "Penjenamaan atau Merek", room: "302", seat: "4", day: "Jumat" },
            { id: "BUS201", date: "2025-10-30", time: "14:00", subject: "Tehnik Proyeksi Bisnis", room: "301", seat: "15", day: "Kamis" },
            { id: "ETH202", date: "2025-10-28", time: "08:30", subject: "Etika Bisnis", room: "204", seat: "21", day: "Selasa" },
            { id: "MAN303", date: "2025-11-05", time: "08:30", subject: "Manajemen Produk dan Harga", room: "301", seat: "12", day: "Rabu" }
        ];

        // --- STATE APLIKASI ---
        // Mencoba memuat status selesai dari localStorage
        let completedExams = {};
        try {
            const storedCompleted = localStorage.getItem('completedExams');
            if (storedCompleted) {
                completedExams = JSON.parse(storedCompleted);
            }
        } catch (e) {
            console.error("Gagal memuat localStorage:", e);
            completedExams = {};
        }

        /**
         * Menyimpan status selesai ke localStorage
         */
        function saveCompletedStatus() {
            try {
                localStorage.setItem('completedExams', JSON.stringify(completedExams));
            } catch (e) {
                console.error("Gagal menyimpan ke localStorage:", e);
            }
        }

        // --- ELEMEN DOM ---
        const scheduleList = document.getElementById('scheduleList');
        const sortOrderSelect = document.getElementById('sortOrder');
        const exportAllButton = document.getElementById('exportAllButton');
        const countdownBox = document.getElementById('countdownBox');
        const nextExamSubject = document.getElementById('nextExamSubject');
        const countdownTimer = document.getElementById('countdownTimer');
        let countdownInterval;

        // --- FUNGSI UTAMA ---

        /**
         * Mengisi daftar jadwal ke dalam HTML
         */
        function populateSchedule(sortBy = 'date') {
            scheduleList.innerHTML = '';
            const sortedData = sortData(scheduleData, sortBy);
            
            sortedData.forEach((item, index) => {
                const isCompleted = completedExams[item.id] || false;
                const { gCalLink } = generateGCalLink(item);

                const card = document.createElement('div');
                card.className = `relative bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden card-animated fade-in ${isCompleted ? 'opacity-60' : ''}`;
                card.style.animationDelay = `${index * 0.05}s`;

                // Tentukan warna bilah hari
                let dayColorClass = 'day-senin'; // default
                if (item.day === 'Selasa') dayColorClass = 'day-selasa';
                else if (item.day === 'Rabu') dayColorClass = 'day-rabu';
                else if (item.day === 'Kamis') dayColorClass = 'day-kamis';
                else if (item.day === 'Jumat') dayColorClass = 'day-jumat';

                card.innerHTML = `
                    <!-- Bilah Warna Hari -->
                    <div class="day-bar ${dayColorClass}"></div>
                    
                    <div class="p-6 pl-10"> <!-- Padding kiri ditambah untuk memberi ruang pada bilah warna -->
                        <div class="flex flex-col justify-between h-full gap-4">
                            <div>
                                <!-- Bagian Atas: Tanggal dan Checkbox Selesai -->
                                <div class="flex justify-between items-start mb-2">
                                    <p class="text-sm font-semibold text-indigo-700">${item.day}, ${formatDate(item.date)}</p>
                                    <div class="flex items-center gap-2 text-sm text-gray-600">
                                        <label for="check-${item.id}" class="cursor-pointer">Selesai</label>
                                        <input type="checkbox" id="check-${item.id}" data-id="${item.id}" 
                                               class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-gray-300 cursor-pointer" 
                                               ${isCompleted ? 'checked' : ''}>
                                    </div>
                                </div>
                                
                                <!-- Judul Mata Kuliah -->
                                <h2 class="text-2xl font-bold text-gray-900 ${isCompleted ? 'line-through' : ''}">${item.subject}</h2>
                                
                                <!-- Detail Ujian -->
                                <div class="flex flex-wrap gap-x-5 gap-y-2 text-gray-600 mt-3">
                                    <span class="flex items-center gap-1.5" title="Waktu">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5H10.75V5z" clip-rule="evenodd" /></svg>
                                        ${item.time} WIB
                                    </span>
                                    <span class="flex items-center gap-1.5" title="Ruang Ujian">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 10.414V17a1 1 0 01-1 1h-3a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1V10.414a1 1 0 01.293-.707l7-7z" clip-rule="evenodd" /></svg>
                                        Ruang: ${item.room}
                                    </span>
                                    <span class="flex items-center gap-1.5" title="Nomor Kursi">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M11.25 5.337c0-.355-.186-.676-.401-.959a.75.75 0 00-1.015-.099l-5.25 3.5a.75.75 0 000 1.222l5.25 3.5a.75.75 0 001.015-.099c.215-.283.401-.604.401-.959V12a1 1 0 112 0v.5A2.25 2.25 0 0110.5 15c-.463 0-.901-.14-.125-.389V5.772A2.215 2.215 0 0110.5 3 2.25 2.25 0 0112.75 5.25v.087c0 .355.186.676.401.959a.75.75 0 001.015.099l2.25-1.5a.75.75 0 000-1.222l-2.25-1.5a.75.75 0 00-1.015.099c-.215.283-.401.604-.401-.959V3a1 1 0 11-2 0v2.337z" /><path d="M5 6.25a.75.75 0 00-1.5 0v7.5a.75.75 0 001.5 0v-7.5z" /></svg>
                                        Kursi: ${item.seat}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Tombol Aksi -->
                            <a href="${gCalLink}" target="_blank" rel="noopener noreferrer" 
                               class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md btn-animated flex items-center justify-center gap-2 text-center 
                                      ${isCompleted ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'hover:bg-indigo-700'}"
                               ${isCompleted ? 'aria-disabled="true" tabindex="-1"' : ''}>
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.25 3A2.25 2.25 0 003 5.25v9.5A2.25 2.25 0 005.25 17h9.5A2.25 2.25 0 0017 14.75V8.25A2.25 2.25 0 0014.75 6H12v2.25A2.25 2.25 0 019.75 10.5h-1.5A2.25 2.25 0 016 8.25V6H5.25zm3.75 3a.75.75 0 000 1.5h1.5a.75.75 0 000-1.5h-1.5z" /></svg>
                                Tambah ke Kalender
                            </a>
                        </div>
                    </div>
                `;
                scheduleList.appendChild(card);
            });

            // Tambahkan event listener untuk checkbox setelah dibuat
            addCheckboxListeners();
            // Perbarui hitung mundur
            updateCountdown();
        }

        /**
         * Menambahkan event listener ke semua checkbox
         */
        function addCheckboxListeners() {
            const checkboxes = scheduleList.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const examId = e.target.dataset.id;
                    const isChecked = e.target.checked;
                    completedExams[examId] = isChecked;
                    saveCompletedStatus();
                    
                    // Perbarui tampilan kartu secara langsung
                    const card = e.target.closest('.card-animated');
                    const title = card.querySelector('h2');
                    const gcalButton = card.querySelector('a[target="_blank"]');
                    
                    if (isChecked) {
                        card.classList.add('opacity-60');
                        title.classList.add('line-through');
                        gcalButton.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                        gcalButton.classList.remove('hover:bg-indigo-700');
                        gcalButton.setAttribute('aria-disabled', 'true');
                        gcalButton.setAttribute('tabindex', '-1');
                    } else {
                        card.classList.remove('opacity-60');
                        title.classList.remove('line-through');
                        gcalButton.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                        gcalButton.classList.add('hover:bg-indigo-700');
                        gcalButton.removeAttribute('aria-disabled');
                        gcalButton.removeAttribute('tabindex');
                    }
                });
            });
        }

        /**
         * Memformat tanggal (YYYY-MM-DD) menjadi format (DD MMMM YYYY)
         */
        function formatDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        /**
         * Mengurutkan data
         */
        function sortData(data, sortBy) {
            const dataToSort = [...data];
            if (sortBy === 'date') {
                return dataToSort.sort((a, b) => {
                    const dateTimeA = new Date(`${a.date}T${a.time}`);
                    const dateTimeB = new Date(`${b.date}T${b.time}`);
                    return dateTimeA - dateTimeB;
                });
            } else if (sortBy === 'alphabetical') {
                return dataToSort.sort((a, b) => a.subject.localeCompare(b.subject));
            }
            return dataToSort;
        }

        /**
         * Membuat link Google Calendar
         */
        function generateGCalLink(item, durationHours = 2) {
            const startTime = new Date(`${item.date}T${item.time}:00+07:00`); // Asumsi WIB (GMT+7)
            const endTime = new Date(startTime.getTime() + durationHours * 60 * 60 * 1000);

            const formatGCalTime = (date) => date.toISOString().replace(/-|:|\.\d+/g, '');

            const gCalDetails = {
                text: `UTS: ${item.subject}`,
                dates: `${formatGCalTime(startTime)}/${formatGCalTime(endTime)}`,
                details: `Ujian Tengah Semester: ${item.subject}\nRuang: ${item.room}\nKursi: ${item.seat}`,
                location: `Ruang ${item.room}, Kampus`,
                ctz: 'Asia/Jakarta'
            };

            const gCalLink = `https://www.google.com/calendar/render?action=TEMPLATE&${new URLSearchParams(gCalDetails)}`;
            
            return { gCalLink, startTime, endTime };
        }

        // --- FITUR HITUNG MUNDUR ---

        /**
         * Mencari ujian berikutnya
         */
        function findNextExam() {
            const now = new Date();
            const sortedByDate = sortData(scheduleData, 'date');
            
            for (const item of sortedByDate) {
                const { endTime } = generateGCalLink(item);
                if (endTime > now) {
                    return item;
                }
            }
            return null; // Semua ujian telah selesai
        }

        /**
         * Memperbarui UI hitung mundur
         */
        function updateCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            const nextExam = findNextExam();
            if (!nextExam) {
                countdownBox.classList.remove('hidden');
                nextExamSubject.textContent = "Semua Ujian Telah Selesai!";
                countdownTimer.textContent = "Selamat! 🎉";
                return;
            }

            countdownBox.classList.remove('hidden');
            nextExamSubject.textContent = nextExam.subject;

            countdownInterval = setInterval(() => {
                const now = new Date();
                const { startTime, endTime } = generateGCalLink(nextExam);

                if (now < startTime) {
                    const diff = startTime - now;
                    const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diff % (1000 * 60)) / 1000);
                    countdownTimer.textContent = `${d} hari ${h} jam ${m} mnt ${s} dtk`;
                } else if (now >= startTime && now < endTime) {
                    countdownTimer.textContent = "Sedang Berlangsung!";
                } else {
                    clearInterval(countdownInterval);
                    updateCountdown(); 
                }
            }, 1000);
        }

        // --- FITUR EKSPOR .ICS ---

        /**
         * Membuat dan mengunduh file .ics
         */
        function generateICSFile() {
            let icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//JadwalUTS//Meliana Gita Puspitasari//ID'
            ];

            const dataToExport = sortData(scheduleData, 'date');

            dataToExport.forEach(item => {
                const { startTime, endTime } = generateGCalLink(item);
                const formatICSTime = (date) => date.toISOString().replace(/-|:|\.\d+/g, '').slice(0, 15);
                const uid = `${formatICSTime(startTime)}-${item.id}@jadwal.uts`;

                icsContent.push(
                    'BEGIN:VEVENT',
                    `UID:${uid}`,
                    `DTSTAMP:${formatICSTime(new Date())}`,
                    `DTSTART;TZID=Asia/Jakarta:${formatICSTime(startTime)}`,
                    `DTEND;TZID=Asia/Jakarta:${formatICSTime(endTime)}`,
                    `SUMMARY:UTS: ${item.subject}`,
                    `DESCRIPTION:Ujian Tengah Semester: ${item.subject}\\nRuang: ${item.room}\\nKursi: ${item.seat}`,
                    `LOCATION:Ruang ${item.room}, Kampus`,
                    'END:VEVENT'
                );
            });

            icsContent.push('END:VCALENDAR');

            const blob = new Blob([icsContent.join('\r\n')], { type: 'text/calendar' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Jadwal_UTS_Meliana.ics';
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // --- EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            populateSchedule('date'); 
        });

        sortOrderSelect.addEventListener('change', (e) => {
            populateSchedule(e.target.value);
        });

        exportAllButton.addEventListener('click', generateICSFile);

        // --- PWA Service Worker ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

    </script>
</body>
</html>

