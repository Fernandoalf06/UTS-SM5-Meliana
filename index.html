<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal UTS - 1123210254</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Konfigurasi PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e40af">
    
    <!-- Ikon Apple Touch -->
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1e40af/ffffff?text=UTS">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Menggunakan font Inter sebagai default */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Animasi fade-in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Style untuk hitung mundur */
        .countdown-box {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            animation: fadeIn 0.5s ease-out;
        }
        /* Menghilangkan panah di input number */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="w-full max-w-4xl mx-auto">
        <!-- Header -->
        <header class="mb-6 fade-in">
            <h1 class="text-3xl font-bold text-gray-900">Jadwal UTS (Gasal 2025/2026)</h1>
            <p class="text-lg text-gray-600">Meliana Gita Puspitasari (1123210254)</p>
        </header>

        <!-- Boks Hitung Mundur -->
        <div id="countdownBox" class="countdown-box text-white p-5 rounded-lg shadow-lg mb-6 hidden">
            <h2 class="text-lg font-semibold">Ujian Berikutnya:</h2>
            <p id="nextExamSubject" class="text-2xl font-bold"></p>
            <p id="countdownTimer" class="text-xl mt-1"></p>
        </div>

        <!-- Kontrol Urutkan dan Ekspor -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4 fade-in" style="animation-delay: 0.1s;">
            <!-- Dropdown Urutkan -->
            <div class="flex items-center gap-2">
                <label for="sortOrder" class="text-sm font-medium text-gray-700">Urutkan:</label>
                <select id="sortOrder" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="date" selected>Tanggal Ujian (Terdekat)</option>
                    <option value="alphabetical">Nama Mata Kuliah (A-Z)</option>
                </select>
            </div>
            <!-- Tombol Ekspor -->
            <button id="exportAllButton" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" />
                </svg>
                Ekspor Semua (.ics)
            </button>
        </div>

        <!-- Daftar Jadwal -->
        <div id="scheduleList" class="space-y-4">
            <!-- Kartu jadwal akan dimasukkan oleh JavaScript di sini -->
        </div>
    </div>

    <script>
        // --- DATA JADWAL (DIPERBARUI SESUAI GAMBAR) ---
        // Data jadwal Ujian Tengah Semester
        // Sumber: image_da33db.png
        const scheduleData = [
            { date: "2025-10-30", time: "08:30", subject: "Seminar Pemasaran Kreatif", room: "406", seat: "19", day: "Kamis" },
            { date: "2025-11-04", time: "08:30", subject: "Metodologi Penelitian", room: "401", seat: "16", day: "Selasa" },
            { date: "2025-10-27", time: "14:00", subject: "Manajemen Strategi", room: "401", seat: "25", day: "Senin" },
            { date: "2025-10-31", time: "08:30", subject: "Penjenamaan atau Merek", room: "302", seat: "4", day: "Jumat" },
            { date: "2025-10-30", time: "14:00", subject: "Tehnik Proyeksi Bisnis", room: "301", seat: "15", day: "Kamis" },
            { date: "2025-10-28", time: "08:30", subject: "Etika Bisnis", room: "204", seat: "21", day: "Selasa" },
            { date: "2025-11-05", time: "08:30", subject: "Manajemen Produk dan Harga", room: "301", seat: "12", day: "Rabu" }
        ];

        // --- ELEMEN DOM ---
        const scheduleList = document.getElementById('scheduleList');
        const sortOrderSelect = document.getElementById('sortOrder');
        const exportAllButton = document.getElementById('exportAllButton');
        const countdownBox = document.getElementById('countdownBox');
        const nextExamSubject = document.getElementById('nextExamSubject');
        const countdownTimer = document.getElementById('countdownTimer');
        let countdownInterval;

        // --- FUNGSI UTAMA ---

        /**
         * Mengisi daftar jadwal ke dalam HTML
         */
        function populateSchedule(sortBy = 'date') {
            // Hapus daftar lama
            scheduleList.innerHTML = '';

            // Sortir data
            const sortedData = sortData(scheduleData, sortBy);
            
            // Buat kartu HTML untuk setiap jadwal
            sortedData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg shadow-md border border-gray-200 fade-in';
                card.style.animationDelay = `${index * 0.05}s`;

                // Hitung tanggal dan waktu berakhir (asumsi durasi 2 jam)
                const { gCalLink, startTime, endTime } = generateGCalLink(item);

                card.innerHTML = `
                    <div class="flex flex-col justify-between h-full gap-3">
                        <div>
                            <p class="text-sm font-medium text-blue-700">${item.day}, ${formatDate(item.date)}</p>
                            <h2 class="text-xl font-bold text-gray-900 mt-1">${item.subject}</h2>
                            <div class="flex flex-wrap gap-x-4 gap-y-2 text-gray-600 mt-3">
                                <span class="flex items-center gap-1.5">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5H10.75V5z" clip-rule="evenodd" /></svg>
                                    ${item.time} WIB
                                </span>
                                <span class="flex items-center gap-1.5">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 10.414V17a1 1 0 01-1 1h-3a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1V10.414a1 1 0 01.293-.707l7-7z" clip-rule="evenodd" /></svg>
                                    Ruang: ${item.room}
                                </span>
                                <span class="flex items-center gap-1.5">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M11.25 5.337c0-.355-.186-.676-.401-.959a.75.75 0 00-1.015-.099l-5.25 3.5a.75.75 0 000 1.222l5.25 3.5a.75.75 0 001.015-.099c.215-.283.401-.604.401-.959V12a1 1 0 112 0v.5A2.25 2.25 0 0110.5 15c-.463 0-.901-.14-.125-.389V5.772A2.215 2.215 0 0110.5 3 2.25 2.25 0 0112.75 5.25v.087c0 .355.186.676.401.959a.75.75 0 001.015.099l2.25-1.5a.75.75 0 000-1.222l-2.25-1.5a.75.75 0 00-1.015.099c-.215.283-.401.604-.401-.959V3a1 1 0 11-2 0v2.337z" /><path d="M5 6.25a.75.75 0 00-1.5 0v7.5a.75.75 0 001.5 0v-7.5z" /></svg>
                                    Kursi: ${item.seat}
                                </span>
                            </div>
                        </div>
                        <a href="${gCalLink}" target="_blank" rel="noopener noreferrer" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300 flex items-center justify-center gap-2 text-center">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.25 3A2.25 2.25 0 003 5.25v9.5A2.25 2.25 0 005.25 17h9.5A2.25 2.25 0 0017 14.75V8.25A2.25 2.25 0 0014.75 6H12v2.25A2.25 2.25 0 019.75 10.5h-1.5A2.25 2.25 0 016 8.25V6H5.25zm3.75 3a.75.75 0 000 1.5h1.5a.75.75 0 000-1.5h-1.5z" /></svg>
                            Tambah ke Kalender
                        </a>
                    </div>
                `;
                scheduleList.appendChild(card);
            });

            // Setelah mengisi jadwal, perbarui hitung mundur
            updateCountdown();
        }

        /**
         * Memformat tanggal (YYYY-MM-DD) menjadi format (DD MMMM YYYY)
         */
        function formatDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        /**
         * Mengurutkan data
         */
        function sortData(data, sortBy) {
            // Salin data agar tidak mengubah data aslinya
            const dataToSort = [...data];

            if (sortBy === 'date') {
                return dataToSort.sort((a, b) => {
                    const dateTimeA = new Date(`${a.date}T${a.time}`);
                    const dateTimeB = new Date(`${b.date}T${b.time}`);
                    return dateTimeA - dateTimeB;
                });
            } else if (sortBy === 'alphabetical') {
                return dataToSort.sort((a, b) => a.subject.localeCompare(b.subject));
            }
            return dataToSort;
        }

        /**
         * Membuat link Google Calendar
         */
        function generateGCalLink(item, durationHours = 2) {
            const startTime = new Date(`${item.date}T${item.time}:00+07:00`); // Asumsi WIB (GMT+7)
            const endTime = new Date(startTime.getTime() + durationHours * 60 * 60 * 1000);

            // Format YYYYMMDDTHHMMSSZ
            const formatGCalTime = (date) => date.toISOString().replace(/-|:|\.\d+/g, '');

            const gCalDetails = {
                text: `UTS: ${item.subject}`,
                dates: `${formatGCalTime(startTime)}/${formatGCalTime(endTime)}`,
                details: `Ujian Tengah Semester: ${item.subject}\nRuang: ${item.room}\nKursi: ${item.seat}`,
                location: `Ruang ${item.room}, Kampus`,
                ctz: 'Asia/Jakarta'
            };

            const gCalLink = `https://www.google.com/calendar/render?action=TEMPLATE&${new URLSearchParams(gCalDetails)}`;
            
            return { gCalLink, startTime, endTime };
        }

        // --- FITUR HITUNG MUNDUR ---

        /**
         * Mencari ujian berikutnya
         */
        function findNextExam() {
            const now = new Date();
            const sortedByDate = sortData(scheduleData, 'date');
            
            for (const item of sortedByDate) {
                const { endTime } = generateGCalLink(item);
                if (endTime > now) {
                    // Ini adalah ujian berikutnya atau yang sedang berlangsung
                    return item;
                }
            }
            return null; // Semua ujian telah selesai
        }

        /**
         * Memperbarui UI hitung mundur
         */
        function updateCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            const nextExam = findNextExam();
            if (!nextExam) {
                countdownBox.classList.remove('hidden');
                nextExamSubject.textContent = "Semua Ujian Telah Selesai!";
                countdownTimer.textContent = "Selamat! 🎉";
                return;
            }

            countdownBox.classList.remove('hidden');
            nextExamSubject.textContent = nextExam.subject;

            countdownInterval = setInterval(() => {
                const now = new Date();
                const { startTime, endTime } = generateGCalLink(nextExam);

                if (now < startTime) {
                    // Hitung mundur menuju ujian
                    const diff = startTime - now;
                    const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diff % (1000 * 60)) / 1000);
                    countdownTimer.textContent = `${d} hari ${h} jam ${m} mnt ${s} dtk`;
                } else if (now >= startTime && now < endTime) {
                    // Ujian sedang berlangsung
                    countdownTimer.textContent = "Sedang Berlangsung!";
                } else {
                    // Ujian ini baru saja selesai, cari berikutnya
                    clearInterval(countdownInterval);
                    updateCountdown(); // Rekursif untuk mencari ujian berikutnya
                }
            }, 1000);
        }

        // --- FITUR EKSPOR .ICS ---

        /**
         * Membuat dan mengunduh file .ics
         */
        function generateICSFile() {
            let icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//JadwalUTS//Meliana Gita Puspitasari//ID'
            ];

            const dataToExport = sortData(scheduleData, 'date');

            dataToExport.forEach(item => {
                const { startTime, endTime } = generateGCalLink(item);
                
                // Format YYYYMMDDTHHMMSS
                const formatICSTime = (date) => date.toISOString().replace(/-|:|\.\d+/g, '').slice(0, 15);

                const uid = `${formatICSTime(startTime)}-${item.subject.replace(/ /g, '')}@jadwal.uts`;

                icsContent.push(
                    'BEGIN:VEVENT',
                    `UID:${uid}`,
                    `DTSTAMP:${formatICSTime(new Date())}`,
                    `DTSTART;TZID=Asia/Jakarta:${formatICSTime(startTime)}`,
                    `DTEND;TZID=Asia/Jakarta:${formatICSTime(endTime)}`,
                    `SUMMARY:UTS: ${item.subject}`,
                    `DESCRIPTION:Ujian Tengah Semester: ${item.subject}\\nRuang: ${item.room}\\nKursi: ${item.seat}`,
                    `LOCATION:Ruang ${item.room}, Kampus`,
                    'END:VEVENT'
                );
            });

            icsContent.push('END:VCALENDAR');

            // Buat file dan trigger download
            const blob = new Blob([icsContent.join('\r\n')], { type: 'text/calendar' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Jadwal_UTS_Meliana.ics';
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // --- EVENT LISTENERS ---

        // Saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            populateSchedule('date'); // Urutkan berdasarkan tanggal saat pertama dimuat
        });

        // Saat pilihan urutan diubah
        sortOrderSelect.addEventListener('change', (e) => {
            populateSchedule(e.target.value);
        });

        // Saat tombol ekspor diklik
        exportAllButton.addEventListener('click', generateICSFile);

        // --- PWA Service Worker ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

    </script>
</body>
</html>

