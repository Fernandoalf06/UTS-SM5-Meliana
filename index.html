<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal UTS ke Google Calendar</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Mengatur font default ke Inter */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Animasi fade-in sederhana */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div class="w-full bg-white rounded-xl shadow-2xl overflow-hidden">
        <!-- Header Kartu -->
        <header class="p-6 sm:p-8 bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
            <h1 class="text-2xl sm:text-3xl font-bold mb-2">Jadwal Ujian Tengah Semester (UTS)</h1>
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                <p class="text-lg font-semibold">Meliana Gita Puspitasari</p>
                <p class="text-blue-100 text-sm sm:text-base">1123210254 / S1 Manajemen</p>
            </div>
        </header>

        <!-- Daftar Jadwal -->
        <main class="p-6 sm:p-8">
            <!-- FITUR 1: Hitung Mundur Ujian Berikutnya -->
            <div id="countdown-container" class="mb-6 p-4 bg-blue-50 rounded-lg text-center shadow-inner">
                <p class="font-semibold text-blue-800">Ujian Berikutnya:</p>
                <p id="countdown-subject" class="text-xl font-bold text-blue-900">-</p>
                <p id="countdown-time" class="text-lg text-gray-700">Memuat...</p>
            </div>
            
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
                <h2 class="text-xl font-semibold text-gray-800">Mata Kuliah</h2>
                <div class="flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto">
                    <div class="flex items-center gap-2 w-full sm:w-auto">
                        <label for="sort-select" class="text-sm font-medium text-gray-600 flex-shrink-0">Urutkan:</label>
                        <select id="sort-select" class="w-full sm:w-auto rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm py-2 px-3">
                            <option value="date">Tanggal Ujian (Terdekat)</option>
                            <option value="alpha">Nama Mata Kuliah (A-Z)</option>
                        </select>
                    </div>
                    <!-- FITUR 2: Tombol Ekspor Semua .ics -->
                    <button id="export-ics" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 bg-green-600 text-white font-semibold text-sm rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-opacity-50">
                        <!-- Ikon SVG Unduh -->
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Ekspor Semua
                    </button>
                </div>
            </div>
            <div id="schedule-list" class="space-y-4">
                <!-- Jadwal akan dimasukkan oleh JavaScript di sini -->
                <div class="text-center py-8">
                    <p class="text-gray-500">Memuat jadwal...</p>
                </div>
            </div>
            
            <footer class="mt-6 pt-4 border-t border-gray-200">
                <p class="text-xs text-gray-500 text-center">
                    <strong>Catatan:</strong> Durasi setiap ujian diasumsikan 2 jam. Periksa kembali detail di Google Calendar sebelum menyimpan.
                </p>
            </footer>
        </main>
    </div>

    <script>
        // Data jadwal diekstrak dari PDF
        const scheduleData = [
            { "kodeMK": "11034578", "mataKuliah": "Manajemen Strategi", "kelas": "G", "tanggal": "27-10-2025", "jam": "14:00", "ruang": "401", "kursi": "25" },
            { "kodeMK": "11034773", "mataKuliah": "Manajemen UMKM & Koperasi", "kelas": "A", "tanggal": "28-10-2025", "jam": "08:30", "ruang": "401", "kursi": "25" },
            { "kodeMK": "11034774", "mataKuliah": "Sistem Informasi Manajemen", "kelas": "E", "tanggal": "29-10-2025", "jam": "08:30", "ruang": "401", "kursi": "25" },
            { "kodeMK": "11334775", "mataKuliah": "Seminar Pemasaran Kreatif", "kelas": "A", "tanggal": "30-10-2025", "jam": "08:30", "ruang": "406", "kursi": "19" },
            { "kodeMK": "11043576", "mataKuliah": "Penjenamaan atau Merek", "kelas": "A", "tanggal": "31-10-2025", "jam": "08:30", "ruang": "401", "kursi": "25" },
            { "kodeMK": "11034671", "mataKuliah": "Manajemen Resiko", "kelas": "A", "tanggal": "03-11-2025", "jam": "08:30", "ruang": "401", "kursi": "25" },
            { "kodeMK": "11034672", "mataKuliah": "Metodologi Penelitian", "kelas": "A", "tanggal": "04-11-2025", "jam": "08:30", "ruang": "401", "kursi": "16" }
        ];

        let sortSelect; // Didefinisikan di scope script
        let countdownInterval;
        let nextExamDate = null;
        let nextExamSubject = '';
        let countdownSubjectEl, countdownTimeEl, countdownContainerEl;
        
        /**
         * Mengubah string tanggal (DD-MM-YYYY) dan waktu (HH:MM) menjadi objek Date.
         * @param {string} dateStr - Tanggal format "DD-MM-YYYY"
         * @param {string} timeStr - Waktu format "HH:MM"
         * @returns {Date} Objek Date
         */
        function parseDateTime(dateStr, timeStr) {
            const [day, month, year] = dateStr.split('-').map(Number);
            const [hours, minutes] = timeStr.split(':').map(Number);
            // Bulan di JavaScript dimulai dari 0 (Jan) hingga 11 (Des)
            return new Date(year, month - 1, day, hours, minutes);
        }

        /**
         * Memformat objek Date menjadi format YYYYMMDDTHHMMSSZ (UTC)
         * @param {Date} dateObj - Objek Date
         * @returns {string}
         */
        function formatGoogleDate(dateObj) {
            return dateObj.toISOString().replace(/-|:|\.\d{3}/g, '');
        }

        /**
         * Membuat link Google Calendar dari data acara.
         * @param {object} event - Objek acara dari scheduleData
         * @returns {string} URL untuk Google Calendar
         */
        function generateGoogleCalendarLink(event) {
            const startTime = parseDateTime(event.tanggal, event.jam);
            // Asumsi durasi 2 jam (120 menit)
            const endTime = new Date(startTime.getTime() + 120 * 60000); 

            const title = `UTS: ${event.mataKuliah}`;
            const details = `Mata Kuliah: ${event.mataKuliah} (${event.kodeMK})\nKelas: ${event.kelas}\nRuang: ${event.ruang}\nKursi: ${event.kursi}\n\nNIM: 1123210254`;
            const location = `Ruang ${event.ruang}, Kursi ${event.kursi}`;

            const baseUrl = 'https://www.google.com/calendar/render?action=TEMPLATE';
            const params = new URLSearchParams({
                text: title,
                dates: `${formatGoogleDate(startTime)}/${formatGoogleDate(endTime)}`,
                details: details,
                location: location,
                ctz: 'Asia/Jakarta' // Menentukan zona waktu asli acara
            });

            return `${baseUrl}&${params.toString()}`;
        }

        /**
         * FITUR 1: Mencari ujian berikutnya yang akan datang.
         */
        function findNextExam() {
            const now = new Date();
            // Buat salinan data dan urutkan berdasarkan tanggal
            const sortedData = [...scheduleData].sort((a, b) => {
                return parseDateTime(a.tanggal, a.jam) - parseDateTime(b.tanggal, b.jam);
            });

            let foundExam = false;
            for (const event of sortedData) {
                const examDate = parseDateTime(event.tanggal, event.jam);
                // Asumsi durasi 2 jam
                const examEndDate = new Date(examDate.getTime() + 120 * 60000);

                // Jika waktu ujian berakhir masih di masa depan
                if (examEndDate > now) {
                    nextExamDate = examDate;
                    nextExamSubject = event.mataKuliah;
                    foundExam = true;
                    break;
                }
            }

            if (!foundExam) {
                nextExamDate = null;
                nextExamSubject = 'Semua ujian telah selesai.';
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
            }
        }

        /**
         * FITUR 1: Memperbarui hitung mundur setiap detik.
         */
        function updateCountdown() {
            if (!countdownSubjectEl || !countdownTimeEl) return;

            countdownSubjectEl.textContent = nextExamSubject;

            if (!nextExamDate) {
                countdownTimeEl.textContent = 'Tidak ada jadwal ujian mendatang.';
                countdownContainerEl.classList.replace('bg-blue-50', 'bg-gray-100');
                countdownSubjectEl.classList.replace('text-blue-900', 'text-gray-700');
                return;
            }

            const now = new Date();
            const diff = nextExamDate.getTime() - now.getTime();

            // Jika waktu ujian sudah lewat 2 jam (durasi ujian)
            if (diff < - (120 * 60000)) {
                findNextExam(); // Cari ujian berikutnya
                return;
            }
            
            // Jika sedang berlangsung (dari T-0 sampai T+2jam)
            if (diff <= 0) {
                countdownTimeEl.textContent = 'Sedang Berlangsung!';
                countdownContainerEl.classList.add('animate-pulse');
                countdownContainerEl.classList.replace('bg-blue-50', 'bg-red-100');
                countdownSubjectEl.classList.replace('text-blue-900', 'text-red-700');
                countdownTimeEl.classList.replace('text-gray-700', 'text-red-600');
                return;
            }

            // Hitung sisa waktu
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            countdownTimeEl.textContent = `${days} hari, ${hours} jam, ${minutes} menit, ${seconds} detik`;
        }
        
        /**
         * FITUR 2: Membuat dan mengunduh file .ics untuk semua jadwal.
         */
        function generateICSFile() {
            const icsLines = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Gemini//JadwalUTSApp//ID',
                'CALSCALE:GREGORIAN'
            ];
            
            const dtStamp = formatGoogleDate(new Date());
            const durationMinutes = 120;

            scheduleData.forEach(event => {
                const startDate = parseDateTime(event.tanggal, event.jam);
                const endDate = new Date(startDate.getTime() + durationMinutes * 60000);
                
                const dtStart = formatGoogleDate(startDate);
                const dtEnd = formatGoogleDate(endDate);
                
                const uid = `${dtStart}-${event.kodeMK}@jadwal.uts.app`;
                const title = `UTS: ${event.mataKuliah}`;
                // Ganti newline \n (JavaScript) menjadi \\n (ICS format)
                const details = `Mata Kuliah: ${event.mataKuliah} (${event.kodeMK})\nKelas: ${event.kelas}\nRuang: ${event.ruang}\nKursi: ${event.kursi}`.replace(/\n/g, '\\n');
                const location = `Ruang ${event.ruang}, Kursi ${event.kursi}`;

                icsLines.push(
                    'BEGIN:VEVENT',
                    `UID:${uid}`,
                    `DTSTAMP:${dtStamp}`,
                    `DTSTART:${dtStart}`,
                    `DTEND:${dtEnd}`,
                    `SUMMARY:${title}`,
                    `DESCRIPTION:${details}`,
                    `LOCATION:${location}`,
                    'END:VEVENT'
                );
            });

            icsLines.push('END:VCALENDAR');

            const icsContent = icsLines.join('\r\n'); // Gunakan CRLF
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            
            // Buat link download palsu
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Jadwal_UTS.ics';
            
            // Klik link untuk memulai download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Bersihkan URL objek
            URL.revokeObjectURL(link.href);
        }

        /**
         * Memasukkan data jadwal ke dalam halaman HTML.
         * Fungsi ini sekarang juga mengurus pengurutan.
         */
        function populateSchedule() {
            const scheduleList = document.getElementById('schedule-list');
            if (!scheduleList || !sortSelect) return;

            // Tentukan mode pengurutan
            const sortBy = sortSelect.value;
            let sortedData = [...scheduleData]; // Salin array data

            if (sortBy === 'date') {
                // Urutkan berdasarkan tanggal (terdekat)
                sortedData.sort((a, b) => {
                    return parseDateTime(a.tanggal, a.jam) - parseDateTime(b.tanggal, b.jam);
                });
            } else if (sortBy === 'alpha') {
                // Urutkan berdasarkan nama mata kuliah (A-Z)
                sortedData.sort((a, b) => {
                    return a.mataKuliah.localeCompare(b.mataKuliah);
                });
            }

            // Kosongkan daftar sebelum mengisi
            scheduleList.innerHTML = '';

            // Jika tidak ada data
            if (sortedData.length === 0) {
                scheduleList.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500">Tidak ada jadwal untuk ditampilkan.</p>
                    </div>`;
                return;
            }

            // Masukkan data yang sudah diurutkan ke HTML
            sortedData.forEach(event => {
                const eventCard = document.createElement('div');
                eventCard.className = 'p-5 bg-gray-50 rounded-lg shadow-sm border border-gray-200 transition-shadow duration-300 hover:shadow-md';
                
                const eventDate = parseDateTime(event.tanggal, event.jam);
                const dayName = eventDate.toLocaleDateString('id-ID', { weekday: 'long' });
                const dateString = eventDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
                const timeString = eventDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });

                eventCard.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between sm:items-start">
                        <div class="mb-3 sm:mb-0">
                            <h3 class="text-lg font-semibold text-blue-700">${event.mataKuliah}</h3>
                            <p class="text-sm text-gray-600">${event.kodeMK} / Kelas ${event.kelas}</p>
                        </div>
                        <a href="${generateGoogleCalendarLink(event)}" 
                           target="_blank" 
                           rel="noopener noreferrer"
                           class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white font-medium text-sm rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-50 flex-shrink-0">
                           <!-- Ikon SVG Kalender -->
                           <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Tambah ke Kalender
                        </a>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200 grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm">
                        <div>
                            <p class="text-xs font-medium text-gray-500">Hari & Tanggal</p>
                            <p class="font-semibold text-gray-800">${dayName}, ${dateString}</p>
                        </div>
                        <div>
                            <p class="text-xs font-medium text-gray-500">Waktu</p>
                            <p class="font-semibold text-gray-800">${timeString} WIB</p>
                        </div>
                        <div>
                            <p class="text-xs font-medium text-gray-500">Ruang</p>
                            <p class="font-semibold text-gray-800">${event.ruang}</p>
                        </div>
                        <div>
                            <p class="text-xs font-medium text-gray-500">Kursi</p>
                            <p class="font-semibold text-gray-800">${event.kursi}</p>
                        </div>
                    </div>
                `;
                scheduleList.appendChild(eventCard);
            });
        }

        // Menjalankan fungsi saat halaman selesai dimuat
        document.addEventListener('DOMContentLoaded', () => {
            // Ambil elemen select
            sortSelect = document.getElementById('sort-select');
            
            // Ambil elemen tombol Ekspor
            const exportButton = document.getElementById('export-ics');

            // Ambil elemen Hitung Mundur
            countdownContainerEl = document.getElementById('countdown-container');
            countdownSubjectEl = document.getElementById('countdown-subject');
            countdownTimeEl = document.getElementById('countdown-time');

            // Tambahkan event listener untuk 'change'
            if (sortSelect) {
                sortSelect.addEventListener('change', populateSchedule);
            }
            
            // Tambahkan event listener untuk 'click'
            if (exportButton) {
                exportButton.addEventListener('click', generateICSFile);
            }
            
            // Siapkan dan mulai hitung mundur
            findNextExam();
            updateCountdown(); // Panggil sekali agar tidak kosong saat load
            countdownInterval = setInterval(updateCountdown, 1000);

            // Panggil populateSchedule saat pertama kali load (akan menggunakan default 'date')
            populateSchedule();
        });

    </script>
</body>
</html>

